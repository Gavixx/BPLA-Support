//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "AddUser.h"
#include "AdminForm.h"
#include "DataModule.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TForm6 *Form6;
//---------------------------------------------------------------------------
__fastcall TForm6::TForm6(TComponent* Owner)
	: TForm(Owner)
{
	DataModule1->ConnectToDatabase();
	FillBoxs();
}
//---------------------------------------------------------------------------

void __fastcall TForm6::ButtonAddUserClick(TObject *Sender)
{
	// Перевірка, чи заповнені всі поля
	if (EditName->Text.Trim().IsEmpty() || EditMail->Text.Trim().IsEmpty() || EditNumber->Text.Trim().IsEmpty() || ComboBoxRole->Text.Trim().IsEmpty() || ComboBoxOrg->Text.Trim().IsEmpty())
	{
		ShowMessage("Будь ласка, заповніть всі поля.");
		return;
	}
    if (EditPassword->Text != EditConfirmPassword->Text)
    {
        ShowMessage("Паролі не співпадають. Будь ласка, переконайтесь, що введені паролі однакові.");
        return;
	}

	try
	{
		if (!DataModule1->FDConnection1->Connected)
		{
			DataModule1->ConnectToDatabase();
			if (!DataModule1->FDConnection1->Connected)
			{
				throw Exception("Не вдалося підключитися до бази даних.");
			}
		}

		// Додавання користувача в таблицю Users
		std::unique_ptr<TFDQuery> insertUserQuery(new TFDQuery(NULL));
		insertUserQuery->Connection = DataModule1->FDConnection1;
		insertUserQuery->SQL->Text = "INSERT INTO Users (name, email, phone, role, organization_id) "
									 "VALUES (:name, :email, :phone, :role, (SELECT organization_id FROM Organizations WHERE name = :organization_name))";
		insertUserQuery->ParamByName("name")->AsString = EditName->Text;
		insertUserQuery->ParamByName("email")->AsString = EditMail->Text;
		insertUserQuery->ParamByName("phone")->AsString = EditNumber->Text;
		insertUserQuery->ParamByName("role")->AsString = ComboBoxRole->Text;
		insertUserQuery->ParamByName("organization_name")->AsString = ComboBoxOrg->Text;
		insertUserQuery->ExecSQL();

		// Отримання останнього доданого user_id
		std::unique_ptr<TFDQuery> selectLastUserIDQuery(new TFDQuery(NULL));
		selectLastUserIDQuery->Connection = DataModule1->FDConnection1;
		selectLastUserIDQuery->SQL->Text = "SELECT LAST_INSERT_ID() AS last_user_id";
		selectLastUserIDQuery->Open();
		int lastUserID = selectLastUserIDQuery->FieldByName("last_user_id")->AsInteger;

		// Додавання облікових даних користувача в таблицю UserCredentials
		std::unique_ptr<TFDQuery> insertCredentialsQuery(new TFDQuery(NULL));
		insertCredentialsQuery->Connection = DataModule1->FDConnection1;
		insertCredentialsQuery->SQL->Text = "INSERT INTO UserCredentials (user_id, login, password) "
											"VALUES (:user_id, :login, :password)";
		insertCredentialsQuery->ParamByName("user_id")->AsInteger = lastUserID;
		insertCredentialsQuery->ParamByName("login")->AsString = EditLogin->Text;
		insertCredentialsQuery->ParamByName("password")->AsString = EditPassword->Text;
		insertCredentialsQuery->ExecSQL();

		ShowMessage("Користувача успішно додано!");

		// Очищення полів після додавання
		EditName->Clear();
		EditMail->Clear();
		EditNumber->Clear();
		ComboBoxRole->Text = "";
		ComboBoxOrg->Text = "";
		EditLogin->Clear();
		EditPassword->Clear();
    }
    catch (Exception &e)
    {
        ShowMessage("Помилка під час додавання користувача: " + e.Message);
    }
}

//---------------------------------------------------------------------------
void __fastcall TForm6::FormClose(TObject *Sender, TCloseAction &Action)
{
	TForm2 *AdminForm = dynamic_cast<TForm2*>(Owner);
	if (AdminForm)
	{
		AdminForm->Show();
	}
//	this->Close();
}
//---------------------------------------------------------------------------

void __fastcall TForm6::ButtonCancelClick(TObject *Sender)
{
	TForm2 *AdminForm = dynamic_cast<TForm2*>(Owner);
	AdminForm->Show();
	this->Close();
}
//---------------------------------------------------------------------------

void __fastcall TForm6::FillBoxs(){
	DataModule1->FDQuery1->Close();
	// Заповнення ComboBox для типу дрону
	DataModule1->FDQuery1->SQL->Text = "SELECT DISTINCT role FROM Users";
	DataModule1->FDQuery1->Open();
	ComboBoxRole->Items->Clear();
	while (!DataModule1->FDQuery1->Eof) {
		ComboBoxRole->Items->Add(DataModule1->FDQuery1->FieldByName("role")->AsString);
		DataModule1->FDQuery1->Next();
	}

	// Заповнення ComboBox для назви дрону
	DataModule1->FDQuery1->Close();
	DataModule1->FDQuery1->SQL->Text = "SELECT DISTINCT name FROM Organizations";
	DataModule1->FDQuery1->Open();
	ComboBoxOrg->Items->Clear();
	while (!DataModule1->FDQuery1->Eof) {
		ComboBoxOrg->Items->Add(DataModule1->FDQuery1->FieldByName("name")->AsString);
		DataModule1->FDQuery1->Next();
	}

}
