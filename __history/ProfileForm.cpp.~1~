//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "ProfileForm.h"
#include "DataModule.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TForm8 *Form8;
//---------------------------------------------------------------------------
__fastcall TForm8::TForm8(TComponent* Owner, int userID)
	: TForm(Owner), UserID(userID)
{
}
//---------------------------------------------------------------------------
void __fastcall TForm8::ButtonEditNameClick(TObject *Sender)
{
	EditUserName->Enabled = true;
	ButtonSaveName->Enabled = true;
}
//---------------------------------------------------------------------------
void __fastcall TForm8::ButtonEditEmailClick(TObject *Sender)
{
	EditEmail->Enabled = true;
	ButtonSaveEmail->Enabled = true;
}
//---------------------------------------------------------------------------
void __fastcall TForm8::ButtonPhoneNumberClick(TObject *Sender)
{
	EditPhone->Enabled = true;
	ButtonSavePhoneNumber->Enabled = true;
}
//---------------------------------------------------------------------------
void __fastcall TForm8::ButtonEditLoginClick(TObject *Sender)
{
	EditLogin->Enabled = true;
	ButtonSaveLogin->Enabled = true;
}
//---------------------------------------------------------------------------
void __fastcall TForm8::ButtonEditPasswordClick(TObject *Sender)
{
	EditPassword->Enabled = true;
	ButtonSavePassword->Enabled = true;
}
//---------------------------------------------------------------------------
void __fastcall TForm8::FormCreate(TObject *Sender)
{
	LoadData();
}
//---------------------------------------------------------------------------
void __fastcall TForm8::LoadData(){
	   try
	{
		if (!DataModule1->FDConnection1->Connected)
		{
			DataModule1->ConnectToDatabase();
			if (!DataModule1->FDConnection1->Connected)
			{
				throw Exception("Не вдалося підключитися до бази даних.");
			}
		}

		std::unique_ptr<TFDQuery> selectProfileQuery(new TFDQuery(NULL));
		selectProfileQuery->Connection = DataModule1->FDConnection1;
		selectProfileQuery->SQL->Text = "SELECT u.name, u.email, u.phone, uc.login, uc.password FROM Users u "
									  "JOIN UserCredentials uc ON u.user_id = uc.user_id WHERE u.user_id = :user_id";
		selectProfileQuery->ParamByName("user_id")->AsInteger = UserID;
		selectProfileQuery->Open();

		if (!selectProfileQuery->Eof)
		{
			EditUserName->Text = selectProfileQuery->FieldByName("name")->AsString;
			EditEmail->Text = selectProfileQuery->FieldByName("email")->AsString;
			EditPhone->Text = selectProfileQuery->FieldByName("phone")->AsString;
			EditLogin->Text = selectProfileQuery->FieldByName("login")->AsString;
			EditPassword->Text = selectProfileQuery->FieldByName("password")->AsString;
		}
	}
	catch (Exception &e)
	{
		ShowMessage("Помилка під час завантаження даних профілю: " + e.Message);
	}

}
